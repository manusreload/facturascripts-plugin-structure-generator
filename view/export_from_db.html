{include="header"}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 col-sm-7 col-xs-8">
            <div class="btn-group hidden-xs">
                <a class="btn btn-sm btn-default" href="?page=export_from_db" title="Recargar la página">
                    <span class="glyphicon glyphicon-refresh"></span>
                </a>
            </div>
            {if="$fsc->table"}
            <div class="btn-group">
                <a class="btn btn-sm btn-default" href="index.php?page=export_from_db">
                    <span class="glyphicon glyphicon-arrow-left"></span> Tablas
                </a>
            </div>
            {/if}
        </div>

    </div>
</div>
<div class="container-fluid">

    {if="$fsc->tables"}
    <h1>Seleccione la tabla que desea generar</h1>
    {if="!$fsc->all"}<div class="alert alert-info">Solo se muestran las tablas que no se han generado un modelo. <a href="?page=export_from_db&all=1">Ver todas las tablas</a></div>{/if}
    <div class="list-group">

        {loop="$fsc->tables"}
            {loop="value"}
        {if="$fsc->all || (!$fsc->validModel($fsc->parseModel($value)) && !$fsc->isInternalModel($fsc->parseModel($value)))"}
            <a href="?page=export_from_db&table={$value}" class="list-group-item"><b>{$fsc->parseModel($value)}</b> {$value}</a>
        {/if}
            {/loop}
        {/loop}


    </div>
    {else}
    <h1>Estructura XML <code>(model/table/{$fsc->table}.xml)</code></h1>
    <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!--
    Document   : {$fsc->table}.xml
    Description:
        Estructura de la tabla {$fsc->table}.
--&gt;
&lt;tabla&gt;
{loop="$fsc->items"}
    &lt;columna&gt;
        &lt;nombre&gt;{$value['Field']}&lt;/nombre&gt;
        &lt;tipo&gt;{$fsc->parseType($value['Type'])}&lt;/tipo&gt;
        &lt;nulo&gt;{$value['Null']}&lt;/nulo&gt; {if="$value['Default'] != '' || $value['Extra'] != '' "}
        &lt;defecto&gt;{$fsc->parseDefault($fsc->table, $value)}&lt;/defecto&gt;{/if}
    &lt;/columna&gt;
{/loop}
{loop="$fsc->items"}{if="$value['Key'] == 'PRI'"}
    &lt;restriccion&gt;
        &lt;nombre&gt;{$fsc->table}_pkey&lt;/nombre&gt;
        &lt;consulta&gt;PRIMARY KEY ({$value['Field']})&lt;/consulta&gt;
    &lt;/restriccion&gt;
    {/if}{/loop}
    {loop="$fsc->foreign"}
    &lt;restriccion&gt;
        &lt;nombre&gt;{$fsc->table}_{$value['key']}_{$value['table']}_{$value['column']}&lt;/nombre&gt;
        &lt;consulta&gt;FOREIGN KEY ({$value['key']})
        REFERENCES {$value['table']} ({$value['column']})
        ON DELETE RESTRICT ON UPDATE CASCADE
        &lt;/consulta&gt;
    &lt;/restriccion&gt;
    {/loop}
&lt;/tabla&gt;</pre>
    <h1>Estructura PHP <code>(model/{$fsc->model}.php)</code></h1>
    <pre>&lt;?php
/*
* Dependencies generated by the foreign keys
*/
{loop="$fsc->foreign"}{if="$fsc->validModel($fsc->parseModel($value['table']))"}
require_model("{$fsc->parseModel($value['table'])}.php");
{/if}{/loop}

{loop="$fsc->items"}{if="$value['Key'] == 'PRI'"}{if="!$primary"}/* Primary key found: {$primary = $value['Field']}*/{/if}{/if}{/loop}
class {$fsc->model} extends fs_model
{
{loop="$fsc->items"}    var ${$value['Field']};
{/loop}
{loop="$fsc->foreign"}{if="$fsc->validModel($fsc->parseModel($value['table']))"}
    /**
    * @var {$fsc->parseModel($value['table'])} {$fsc->parseModel($value['table'])}
    */
    var ${$fsc->parseModel($value['table'])};
{/if}{/loop}
    public function __construct($data=FALSE)
    {
        $pluginname = str_replace(realpath(".") . "/", "",  realpath(__DIR__ . "/..") ) . "/";
        parent::__construct('{$fsc->table}', $pluginname);
        {loop="$fsc->foreign"}{if="$fsc->validModel($fsc->parseModel($value['table']))"}
        $this->{$fsc->parseModel($value['table'])} = $this->{$fsc->parseModel($value['table'])}->get($data['{$value['key']}']);
{/if}{/loop}
        if($data)
        {
{loop="$fsc->items"}
            $this->{$value['Field']} = {$fsc->evalFunction($value['Type'],  $value['Field'])};{/loop}
{loop="$fsc->foreign"}{if="$fsc->validModel($fsc->parseModel($value['table']))"}
            $this->{$fsc->parseModel($value['table'])} = $this->{$fsc->parseModel($value['table'])}->get($data['{$value['key']}']);
{/if}{/loop}
        }
    }

    /**
     * Esta función es llamada al crear una tabla.
     * Permite insertar valores en la tabla.
     */
    protected function install()
    {
        return '';
    }

    /**
     * Esta función devuelve TRUE si los datos del objeto se encuentran
     * en la base de datos.
     */
    public function exists()
    {
        {if="$primary"}
        if($this->{$primary})
        {
            $value = $this->var2str($this->{$primary});
            return $this->db->select("SELECT * FROM {noparse}{$this->table_name}{/noparse} WHERE {$primary} = $value");
        }
        {else}
        // Can't auto generate exists function, because the table does not have PRIMARY KEY
        {/if}
        return false;
    }

    /**
     * Esta función sirve tanto para insertar como para actualizar
     * los datos del objeto en la base de datos.
     */
    public function save()
    {
        $sql = "";
        if($this->exists())
        {{if="$primary"}
            $value = $this->var2str($this->{$primary});
            if($this->{$primary})
            {
                $sql = "UPDATE {noparse}{$this->table_name}{/noparse} SET {loop="$fsc->items"}{if="$counter++ > 0"}, {/if}{$value['Field']} = " . $this->var2str($this->{$value['Field']}) . "
                        {/loop}  WHERE {$primary} = $value";
                return $this->db->exec($sql);
            }
            {else}
            // Can't auto generate save function for update, because the table does not have PRIMARY KEY
            {/if}
        }
        else
        {
            $sql = "INSERT INTO {noparse}{$this->table_name}{/noparse} (
                                    {loop="$fsc->items"}{if="$counter++ > 0"}, {/if}{$value['Field']}
                                    {/loop}
                                ) VALUES (
                                    {loop="$fsc->items"}{if="$counter++ > 0"}, {/if} " . $this->var2str($this->{$value['Field']}) . "
                                    {/loop}
                                )";
            return $this->db->exec($sql);
        }

        return false;
    }

    /**
     * Esta función sirve para eliminar los datos del objeto de la base de datos
     */
    public function delete()
    {
        {if="$primary"}
        $value = $this->var2str($this->{$primary});
        if($this->{$primary})
        {
            $sql = "DELETE FROM {noparse}{$this->table_name}{/noparse} WHERE {$primary} = $value)";
            return $this->db->exec($sql);
        }
        {else}
        // Can't auto generate delete function for update, because the table does not have PRIMARY KEY
        {/if}
    }
    {if="$primary"}
    public function get($cod)
    {
        $cod = $this->var2str($cod);
        return $this->parse($this->db->select("SELECT * FROM {noparse}{$this->table_name}{/noparse} WHERE {$primary} = $cod"));
    }
    {/if}
    public function get_all_offset($offset=0, $limit=FS_ITEM_LIMIT)
    {
        return $this->parse($this->db->select_limit("SELECT * FROM {noparse}{$this->table_name}{/noparse} {if="$primary"}ORDER BY {$primary} DESC{/if}", $limit, $offset), true);
    }
    public function get_all()
    {
        return $this->parse($this->db->select("SELECT * FROM {noparse}{$this->table_name}{/noparse} {if="$primary"}ORDER BY {$primary} DESC{/if}"), true);
    }
    public function parse($items, $array = false)
    {
        if(count($items) > 1 || $array)
        {
            $list = array();
            foreach($items as $item)
            {
                $list[] = new {$fsc->model}($item);
            }
            return $list;
        }
        else if(count($items) == 1)
        {
            return new {$fsc->model}($items[0]);
        }
        return null;
    }

}
    </pre>
    {/if}

</div>

{include="footer"}